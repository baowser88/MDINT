document.getElementById('user-name').addEventListener('change', function () {
    const selectedName = this.value;
    const docteurFields = document.querySelectorAll('[name="docteur[]"]');
    docteurFields.forEach(field => field.value = selectedName);
});

// Handle exemption type change to show/hide task dropdown
document.addEventListener('change', function (e) {
    if (e.target.name === 'exemption_type[]') {
        const taskContainer = e.target.closest('.request-row').querySelector('.task-container');
        if (e.target.value === 'Task') {
            taskContainer.style.display = 'flex'; // Show task dropdown
        } else {
            taskContainer.style.display = 'none'; // Hide task dropdown
        }
    }
});

// Initialize Flatpickr
function initializeFlatpickr() {
    flatpickr('[name="date_range[]"]', {
        mode: "range",
        dateFormat: "Y-m-d",
        minDate: "today",
    });
}
initializeFlatpickr();

// Add another row for requests
document.getElementById('add-row').addEventListener('click', () => {
    const row = document.querySelector('.request-row').cloneNode(true);
    row.querySelectorAll('input, select').forEach(input => {
        if (input.name === 'docteur[]') {
            input.value = document.getElementById('user-name').value; // Keep username
        } else {
            input.value = ''; // Clear other fields
        }
    });

    // Add spacer
    const spacer = document.createElement('hr');
    document.getElementById('form-container').appendChild(spacer);

    document.getElementById('form-container').appendChild(row);
    initializeFlatpickr(); // Reinitialize Flatpickr for the new row
});

// Remove a row
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-row')) {
        const row = e.target.closest('.request-row');
        const spacer = row.nextElementSibling;
        if (spacer && spacer.tagName === 'HR') {
            spacer.remove(); // Remove the spacer
        }
        row.remove();
    }
});

// Form submission handler
document.getElementById('exemption-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const rows = document.querySelectorAll('.request-row');
    const formData = Array.from(rows).map(row => {
        return {
            docteur: row.querySelector('[name="docteur[]"]').value,
            exemptionType: row.querySelector('[name="exemption_type[]"]').value,
            specificTask: row.querySelector('[name="specific_task[]"]')?.value || '',
            dateRange: row.querySelector('[name="date_range[]"]').value,
        };
    });

    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbwncH8iZqGNTcB0PO1wwy3I7KGJGxbSy6Ju5GvWUtfyJojV-FqwVLfxVhddMk6tlh_qaA/exec', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ requests: formData }),
        });

        const result = await response.json();
        if (result.status === "success") {
            alert("Request submitted successfully!");
            e.target.reset();
        } else {
            alert("Failed to submit. Please try again.");
        }
    } catch (error) {
        console.error("Error submitting form:", error);
        alert("There was an error. Please try again later.");
    }
});
